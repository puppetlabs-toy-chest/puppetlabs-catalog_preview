puppet-preview(8) -- Puppet catalog compilation diff
========

SYNOPSIS
--------
Compiles two catalogs one in the baseline environment, and one in a preview environment
and computes a diff between the two. Produces the two catalogs, the diff, and the
logs from each compilation for inspection.

USAGE
-----
```
puppet preview [-d|--debug] [-h|--help]
  [ --preview_env <ENV-NAME>
    [--baseline_env <ENV-NAME>]
    [--migrate]
    [--view summary|baseline|preview|diff|baseline_log|preview_log|none]
    [--assert equal|compliant]
    [--preview_output_dir <PATH-TO-OUTPUT-DIR>]
    [--skip_tags]
    [-V|--version]
    [--node <NODE-NAME>]
  ]|[--schema catalog|catalog_delta]
```

DESCRIPTION
-----------
This command compiles, compares, and asserts a baseline catalog and a preview catalog
for a node that has previously requested a catalog from a puppet master (thereby making
its facts available). The compilation of the baseline catalog takes place in the
environment configured for the node (optionally overridden with '--baseline_env').
The compilation of the preview takes place in the environment
designated by '--preview_env'.

By default the command outputs a summary report of the difference between the two
catalogs on 'stdout'. This can be changed with '--view' to instead view
one of the catalogs, the diff, or one of the compilation logs.

When the preview compilation is performed, it is possible to turn on extra
migration validation using '--migrate'. This will turn on extra validations
of future compatibility flagging puppet code that needs to be reviewed. This
feature was introduced to help with the migration from puppet 3.x to puppet 4.x.
and requires that the '--preview_env' references an environment configured
to use the future parser in its environment.conf.

All output (except the summary report intended for human use) is written in
JSON format to allow further processing with tools like 'jq' (JSON query).

The output is written to a subdirectory named after the node of the directory appointed by the setting 'preview_output_dir':

    |- "$preview_output-dir"
    |  |
    |  |- <NODE-NAME-1>
    |  |  |- preview_catalog_.json
    |  |  |- baseline_catalog.json
    |  |  |- preview_log.json
    |  |  |- baseline_log.json
    |  |  |- catalog_diff.json
    |  |  
    |  |- <NODE-NAME-2>
    |  |  |- ...
 
Each new invocation of the command for a given node overwrites the information already produced.

The two catalogs are written in JSON compliant with a json-schema ('catalog.json'; the format
used by puppet to represent catalogs in JSON) viable on stdout using '--schema catalog'

The 'catalog_diff.json' file is written in JSON compliant with a json-schema viable on stdout
using '--schema catalog_delta'.

OPTIONS
-------

Note that any Puppet setting that's valid in the configuration file is also a
valid long argument. For example, 'server' is a valid setting, so you can
specify '--server <servername>' as an argument. Boolean settings translate into
'--setting' and '--no-setting' pairs.

See the configuration file documentation at
http://docs.puppetlabs.com/references/stable/configuration.html for the
full list of acceptable settings. A commented list of all settings can also be
generated by running puppet master with '--genconfig'.

Note that all settings such as 'log_level' affects both compilations.

* --debug:
  Enable full debugging. Debugging output is sent to the respective log outputs
  for baseline and preview compilation. This option is for both compilations.

* --help:
  Print this help message.

* --version:
  Print the puppet version number and exit.

* --baseline_env <ENV-NAME>:
  Makes the baseline compilation take place in the given <ENV>.
  Uses facts contained in the $vardir/yaml/ directory to compile the catalog.

* --preview_env <ENV-NAME>:
  Makes the preview compilation take place in the given <ENV>.
  Uses facts contained in the $vardir/yaml/ directory to compile the catalog.
  
* --view summary | diff | baseline | preview | baseline_log | preview_log | none
  Specifies what will be output on stdout; the catalog diff, one of the two
  catalogs, or one of the two logs. The option 'none' turns off output to stdout.
  
* --migrate
  Turns on migration validation for the preview compilation. Validation result
  is produced to the preview log file or optionally to stdout with --view preview_log
  
* --assert equal | compliant
  Modifies the exit code to be -4 if catalogs are not equal and -5 if the preview
  catalog is not compliant instead of an exit with 0 to indicate that the preview run was
  successful in itself. 
  
* --preview_output_dir <DIR>
  Defines the director to which output is produced.
  This is a puppet setting that can be overridden on the command line.

* --node <NODE-NAME>
  This specifies for which node the preview should produce output. The node must
  have previously requested a catalog from the master to make its facts available.
  
* --schema catalog | catalog_delta
  Outputs the json-schema for the puppet catalog, or for the catalog_delta. Can not be
  combined with any other option.
  
* --max_value_size n
  Sets the max value size to n characters. Values larger than this will be abbreviated if they
  appear in the missing or added categories. For a conflicting attribute a value larger than this 
  will be processed with the diff command specified by '--diff_cmd' and written to
  a file named after the attribute's 'diff_id'
  
* --ignore-tags
  Ignores comparison of tags, catalogs are considered equal if they only differ in tags.  


EXAMPLE
-------
To perform a full migration preview that exists with failure if catalogs are not equal:

    puppet preview --preview_env future_production --migrate --assert=equal mynode
    
To perform a preview that exits with failure if preview catalog is not compliant:

    puppet preview --preview_env future_production --assert=compliant mynode

To perform a preview focusing on if code changes resulted in conflicts in
resources of File type using 'jq' to filter the output (the command is given as one line):

    puppet preview --preview_env future_production --view diff mynode 
    | jq -f '.conflicting_resources | map(select(.type == "File"))'
    
View the catalog schema:

    puppet preview --schema catalog
    
View the catalog-diff schema:

    puppet preview --schema catalog_diff
    
DIAGNOSTICS
-----------
The '--assert' option controls the exit code of the command.

If '--assert' is not specified the command will exit with 0 if the two compilations
succeeded, -2 if the baseline compilation failed (a catalog could not be
produced), and -3 if the preview compilation did not produce a catalog.

If '--assert' is set to 'equal', the command will exit with -4 if the two catalogs
are not equal.

If --assert is set to 'compliant' it will exit with -5 if the content of the
baseline catalog is not a subset of the content of the preview catalog.

The different assert values do not alter what is produced - only the exit value is
different as both equality and compliance is checked in every preview.

The command exits with -1 if there is a general error.

AUTHOR
------
Henrik Lindberg, Puppet Labs


COPYRIGHT
---------
Copyright (c) 2015 Puppet Labs, LLC Licensed under ??????

